<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>Another Blog</title>

    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <meta name="description" content="yet another blog.">

    <link rel="stylesheet" href="/theme/css/pure-min.css" type="text/css" media="all" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="/grids-responsive-old-ie-min.css">
<![endif]-->
<!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="/theme/css/grids-responsive-min.css" type="text/css" media="all" />
<!--<![endif]-->
    <link rel="stylesheet" href="/theme/css/blog.css" type="text/css" media="all" />
    <link rel="stylesheet" href="/theme/css/ty.css" type="text/css" media="all" />
    <link rel="stylesheet" href="/theme/css/highlight.css" type="text/css" media="all" />

    <link href="https://ir193.github.io/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="Another Blog Full Atom Feed" />
    <link href="https://ir193.github.io/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Another Blog Categories Atom Feed" />
    <link href="https://ir193.github.io/feeds/{slug}.rss.xml" type="application/rss+xml" rel="alternate" title="Another Blog Categories RSS Feed" />
    
</head>
<body>

<div id="layout" class="ty pure-g">
    <div class="sidebar pure-u-1 pure-u-md-6-24">
        <div class="header">
            <nav class="navi">
                <span><a href="..">Home</a></span>
                <span class="no-mobile"><a href="../category/life.html">Life</a></span>
                <span class="no-mobile"><a href="../category/security.html">Security</a></span>
                <!-- <span><a href="#">Projects</a></span> -->
                <span><a href="../pages/about.html">About</a></span>
            </nav>
        </div>
    </div>
    <div class="content pure-u-1 pure-u-md-12-24">
        <div class="artical">
<artical class="post post-preview">
    <div class="post-header">
        <h2 class="post-title">
            <a href="../post/cve-2013-2094.html" rel="bookmark" title="CVE-2013-2094 本地提权漏洞">
                CVE-2013-2094 本地提权漏洞
            </a>
        </h2>
    </div>
    <div class="post-content">
        <p><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-2094">cve-2013-2094</a>是于2013年4月前后发现的linux kernel本地漏洞，该漏洞影响3.8.9之前开启了<code>PERF_EVENT</code>的linux系统。利用该漏洞，通过<code>perf_event_open</code>系统调用，本地用户可以获得系统的最高权限。</p>
<!--more-->

<p>发生漏洞的是linux kernel中的perf event子系统，perf event是linux系统中提供性能分析接口的子系统，于2.6.31之后引入linux，之前被称为 Performance Counters for Linux (PCL)。通过syscall函数，用户可以调用perf event子系统提供的功能。由于perf event中的漏洞，用户可以通过精心构造的调用在任何内存地址写入数据，从而获得系统的最高权限。</p>
<p>引起cve-2013-2094漏洞的是位于<a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/events/core.c?id=8176cced706b5e5d15887584150764894e94e02f">kernel/events/core.c</a>文件中的<code>perf_swevent_init</code>函数。当使用syscall打开<code>perf_event</code>的file descriptor时，该函数被调用。</p>
<p>在受影响的版本中，core.c关键部分内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">static</span> <span class="n">int</span> <span class="n">perf_swevent_init</span><span class="p">(</span><span class="n">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="nf">event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">int</span> <span class="n">event_id</span> <span class="o">=</span> <span class="nf">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>  <span class="c1">//dangerous!</span>

    <span class="cm">/*</span>
<span class="cm">     * ....omit some code...</span>
<span class="cm">     */</span>

    <span class="nf">if</span> <span class="p">(</span><span class="n">event_id</span> <span class="o">&gt;=</span> <span class="n">PERF_COUNT_SW_MAX</span><span class="p">)</span>
        <span class="kr">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * .........omit........</span>
<span class="cm">     */</span>

<span class="p">}</span>
</code></pre></div>

<p>由于将<code>event_id</code>定义为了有符号型整数，而后面又只检查了<code>event_id</code>的上界，所以当值为负时，即可越过检查，继续执行后面的代码</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swevent_hlist_get</span><span class="p">(</span><span class="n">event</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="o">[</span><span class="n">event_id</span><span class="o">]</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">event</span><span class="o">-&gt;</span><span class="k">destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sw_perf_event_destroy</span><span class="p">;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
</code></pre></div>

<p>其中，<code>static_key_slow_inc</code>函数将某地址内容做inc。</p>
<p>当使用负数值的<code>event_id</code>调用时，<code>perf_swevent_enabled[event_id]</code>将指向内核空间，如，在Cent OS 64bit系统中，当<code>event_id = -1</code>调用时，<code>perf_swevent_enabled[event_id]</code>的地址为:</p>
<div class="highlight"><pre><span></span><code><span class="mf">0</span><span class="n">xfffffffffffffffe</span> <span class="o">*</span> <span class="mf">4</span> <span class="o">+</span> <span class="mf">0</span><span class="n">xffffffff81f360c0</span> <span class="o">==</span> <span class="mf">0</span><span class="n">xFFFFFFFF81F360B8</span>
</code></pre></div>

<p>该地址指向内核空间。</p>
<p>而当file descriptor关闭时，由于<code>event_id</code>定义为u64型，所以关闭时做dec时，地址指向的是用户空间。</p>
<p>所以当我们用负数值调用<code>perf_event_open</code>时，将可以在<code>perf_swevent_enabled</code>地址后面任意地址写入数据。</p>
<h3>x64下的利用思路</h3>
<p>x64架构下，该漏洞比较容易利用，需要的信息更少，exploit执行更快。方法简单来说是修改IDT中 int 4 的中断向量。x64的linux中，Offset hight bits和Offset middle bits是分别保存的，而将 int 4 的高位 0xffffffff 加1之后，中断向量将指向用户空间。而将shellcode放置在用户空间的这段内存上，即可获得系统最高权限。</p>
<p>具体来说，</p>
<ol>
<li>
<p>使用-1和-2调用，得到数组的偏移值。</p>
<p>使用-1和-2调用，在file descriptor被关闭后，将使 0x38000000 附近的内存中某两个值减1，通过搜索可以确定perf_swevent_enabled的编译值，并保存起来方便利用。</p>
</li>
<li>
<p>将shellcode放入适当的用户空间内存中</p>
<p>使用 sidt 指令可以获得IDT的地址，然后使用 mmap 将 shellcode 放入适当的地址。使 IDT 中的中断向量高位+1之后落在shellcode上。</p>
</li>
<li>
<p>修改shellcode</p>
<p>将 shellcode 中的 MARKER 修改为实际的 uid 和 gid 的保存地址。这样当shellcode运行时，即可找到 task_struct  和 thread_info 的地址，从而直接修改 real_cred 值，使当前进程获得 root 权限。</p>
</li>
<li>
<p>修改 IDT</p>
<p>从 1 中得到的信息，和IDT 地址做计算，用计算好的负数值调用 perf_event_open ，可以使 int 4 的中断向量的高位 +1，从而指向shellcode。</p>
</li>
<li>
<p>int 0x4</p>
<p>触发shellcode</p>
</li>
<li>
<p>在shellcode中提权，并弹shell</p>
<p>修改 real_cred 获得root权限，并修复被修改的 IDT 和其他部分内存，</p>
<p>最后execl("/bin/bash", "-sh", NULL);</p>
<p>得到root权限的shell</p>
</li>
</ol>
<h3>移植到android系统</h3>
<p>Android采用了linux内核，且更新较linux在PC上的发行版慢。即使linux内核在2013年4月13日修复了该漏洞，原生Android系统和大量基于Android系统的第三方ROM仍然存在该漏洞。</p>
<p>在ARM linux下，该漏洞仍然存在，仍然可以通过负数的<code>event_id</code>将任意内存地址+1。</p>
<p>但由于手机使用的ARM架构和x64架构下，linux内核代码有所不同，该漏洞的利用方式也有所不同。</p>
<p>但是在ARM linux下，IDT的结构如下</p>
<div class="highlight"><pre><span></span><code>struct _idt_entry {
  unsigned short base_lo;
  unsigned short sel;
  unsigned char unused;
  unsigned char flags;
  unsigned short base_hi;
} __attribute__((packed));
</code></pre></div>

<p>注意到<code>base_hi</code>是short型，而<code>perf_swevent_enabled</code>是int型的数组，所以无法将地址修改base_hi到用户空间地址。</p>
<p>所以在ARM下我们没有修改IDT，而是在linux内核中寻找合适的函数指针。反复调用<code>perf_event_open</code>，将函数指针的值加到用户能控制的地址，然后调用函数。<code>ptmx_fops</code>结构中的fsync函数指针被初始化为0，且不需要特殊的权限即可调用。</p>
<p>利用的基本思路是：</p>
<div class="highlight"><pre><span></span><code><span class="o">/*</span> <span class="n">file_operations</span> <span class="err">结构</span><span class="n">fsync函数的偏移为56</span> <span class="o">*/</span>
<span class="nb nb-Type">int</span> <span class="n">target</span> <span class="o">=</span> <span class="n">pmtx_ops</span> <span class="o">+</span> <span class="mi">56</span><span class="p">;</span>
<span class="nb nb-Type">int</span> <span class="n">payload</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">perf_table</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

<span class="n">struct</span> <span class="n">perf_event_attr</span> <span class="n">event_attr</span><span class="p">;</span>
<span class="n">event_attr</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>
<span class="o">...</span>

<span class="o">/*</span> <span class="err">反复调用将</span><span class="n">fsync的值修改为合适的值</span> <span class="o">*/</span>
<span class="n">syscall</span><span class="p">(</span><span class="n">__NR_perf_event_open</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="o">...</span>

<span class="o">/*</span> <span class="err">调用</span> <span class="o">*/</span>
<span class="nb nb-Type">int</span> <span class="n">ptmx</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s2">&quot;/dev/ptmx&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
<span class="n">fsync</span><span class="p">(</span><span class="n">ptmx</span><span class="p">);</span>
</code></pre></div>

<p>但是，linux系统中单个进程能够打开的file descriptor数量是有限制的，所以需要fork出足够多的进程，反复修改。</p>
<h3>受影响的ROM</h3>
<p>目前，测试了三款国内比较流行的手机，共4个ROM，该漏洞的情况如下：</p>
<ul>
<li>
<p>Nexus 4 官方Rom 4.2.1 - 成功</p>
</li>
<li>
<p>Nexus 4 Cyanogenmod 10.1.2 - 内核已修补</p>
</li>
<li>
<p>Lenove 860i 官方ROM - 内核不支持perf_event</p>
</li>
<li>
<p>Huawei U9508 官方ROM - 内核不支持perf_event</p>
</li>
</ul>
    </div>
    <div class="post-footer">
        <span class="meta-prep">Post in</span>
        <abbr class="date" title="2013-10-09T01:06:33+08:00"> 
            <a href="../archive/2013/Oct/index.html">
                Oct 09 2013 </a>
        </abbr>
        <br />
        Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
        <span class="meta-prep"> with tags</span>
                <a href="../tag/security.html">Security</a>
                <a href="../tag/linux.html">linux</a>
    </div>
    <div class="clear"></div>
</artical>
<section>
    <div id="disqus_thread">
    <script type="text/javascript">
    var disqus_identifier = "post/cve-2013-2094.html";
    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://ir193.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    </div>

</section>
            <div class="footer">
                Powered by <a href="http://getpelican.com/">Pelican</a> <br />
                which takes great advantage of <a href="http://python.org">Python</a> <br />
                <a title="Web Statistics" href="http://clicky.com/100758617"><img alt="Web Statistics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
            </div>
        </div>
    </div>
    <div class="pure-u-1 pure-u-md-6-24"> </div>
</div>


<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100758617); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100758617ns.gif" /></p></noscript>

</body>
</html>