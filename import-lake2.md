Title: 几个雷客图ASP站长安全助手的小问题
Slug: lake2_bug
Date: 2009-10-08 09:32:35
Tags: Security, imported blog, 
Category: Security
Author: ir193

这是一篇导入的blog，其中的内容大概是09年暑假积累的。写作时间是10月20日，应该是刚刚开学时候去主楼后面的机房写的。

从电脑里翻出来这个真是百感交集啊，现在来看这篇文章，这些小trick确实是原创的，后来也没有再别处听说过。当然这与asp的没落、我不再关注web安全有着不小关系。

大学四年，安全方面的技术确实没有积累，是根本没有看。而现在又想转码，似乎绕了一个圈子又回到了开始。而一圈走下来却发现自己没有留下什么。


### 以下是导入的正文

----

雷客图[http://down.chinaz.com/soft/17030.htm]是大侠lake2开发的基于ASP进行查杀木马、维护网站安全的程序。

雷客图采用正则表达式检查关键字的方法查找ASP木马，重点检查了一些关键组件的方法，如：wscript.shell的exec，fso的OpenTextFile。在网上能见到的ASP查杀工具中，雷客图的查杀率和误杀率都相当突出。但由于ASP脚本语言的特性，还是有一些方法突破雷客图的。本人水平不高，不过是发现几个小问题，写下来请各位高手指正。

1. 突破CreateObject组件检查（针对于老版本）

CreateObject是所有ASP木马不可避免的函数，几乎所有功能都必须由其开始。老版本的雷客图检查了是否包含`&`或`+`以及是否为变量等，防止使用字符串拼接躲过检查。

满足以下条件

* 括号内没有引号

* 括号内出现`&`或者`+`

时即判断为有问题。

但由于vbs的正则表达式默认采用贪婪模式，即匹配最长的满足条件的字符串。这样，假如在CreateObject一行的末尾，又出现一个括号的话，正则表达式将匹配到最后一个括号。为了不产生语法错误，可以把括号放在注释中。像这样：

	<!-- lang:vbs -->
	Function CreateObj(str)
		Set CreateObj = server.CreateObject(str)      '"""")
	End Function

我们以变量作为CreateObject的参数，同时在括号后加上注释。以满足有引号的条件。最后加上括号使表达式匹配到最后一个括号。这样就绕过了检查。

而对于新版本（1.6 sp1），直接用字符串拼接就行了。


2. 空格躲过特征方法检查

除了一些比较危险的组件，雷客图还检查了一些组件的方法。由于组件的方法不能像字符串变量一样拼接，绕过的方法受到限制。

但雷客图的特征码中，为了保证查杀的准确性，都只查杀以`.`开头的关键字。如`.ExecuteStatement`

问题是我们可以在方法前加一个空格，还是可以运行的

	<!-- lang:vbs -->
	wshl. exec strCmd

这个是一个很大的突破，几乎使asp木马彻底绕过了检查。

3. MSScriptControl执行任意语句

雷客图没有查杀MSScriptControl组件的关键字，而这个可以执行任意语句。

这个网上很多了，使用MSScriptControl执行代码，就可以使用`&`或`+`。虽然1.6sp2版本检查了这个组件，但是我们还是可以使用上面的方法躲过查杀。

4. 用Jscript躲过查杀

雷客图的很多特征码是针对VBS的，但ASP也可以用Jscript写。Jscript由于可以自由的换行、插入空格，比VBS更灵活。

比如调用Wscript.shell的exec可以有两种形式：

	<!-- lang:vbs -->
	owshl.exec
	owshl["exec"]

第二种的方法名是字符串形式，所以可以用`+`拼接（不能用`&`）。

5. 万能加密工具

以MSScriptControl主要方法可以写一个万能加密工具，用来躲过雷客图的查杀。但是还没有写。

6. 使用字符集来躲过查杀

这个是JNC大牛说的

	<%@ codepage=65000%>%e+x-x+x-e+x-c+x-u+x-t+x-e+x-(+x-r+x-e+x-q+x-u+x-e+x-s+x-t+x-(+x-+ACI-c+ACI)+x-)+x-%>

雷客图总的来说是一个相当优秀的ASP木马查杀工具，其中有很多东西值得学习。我小菜不敢挑战lake2大侠，无非是在被忽视的地方小打小闹一下。最后，希望lake2多开发一些工具，多公布几个漏洞。

感觉asp真的过时了，看来我小菜要不断进步才能赶上时代的步伐啊~~~~
